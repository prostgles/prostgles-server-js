
	  
<!DOCTYPE html>
<html>
	<head>
        <title> Prostgles </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://unpkg.com/socket.io-client@latest/dist/socket.io.slim.js" type="text/javascript"></script>
        <script src="https://unpkg.com/prostgles-client@latest/dist/index.js" type="text/javascript"></script>	
	</head>
    <body style="margin: 0;">
        <style>
            html, body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            * {
                box-sizing: border-box;
            }
        </style>
        
        <canvas id="canvas" width="100%" height="100%"></canvas>
		<script>
            
            const socket = io({ path: "/teztz" });

            prostgles({
                socket, 
                onReady: async (db, methods) => {
                    window.db = db;
                    initCanvas(db);
                    try {

                        // db.users.subscribe({}, { select: { id: 1, posts: "*" } , limit: 2 }, items => {
                        //     let div = document.querySelector(".wrapper");
                        //     div.innerHTML = JSON.stringify(items, null, 2);
                        // });
                    } catch(e){
                        
                    }
                    // console.log(await db.users.find({}, { select: { posts: "*" } , limit: 1 }) );
                },
                onDisconnect: (err, res) => {
                    // location.reload();
                }
            });

            async function initCanvas(dbo){
                var canvas = document.getElementById('canvas');
                var ctx = canvas.getContext('2d');

                await dbo.Points.delete({});

                const ps = await dbo.Points.sync({}, draw);
                // ps.subscribeAll(draw);
                // dbo.points.subscribe({}, { orderBy: "id", select: ["x", "y", "color", "id"] }, draw)

                function draw(points){
                    console.log(points.length, "Points")
                    if(points && points.length > 1){
                        ctx.beginPath();
                        ctx.moveTo(points[0].x, [points[0].y]);
                        ctx.lineCap = 'round';
                        ctx.lineWidth = 3;

                        points.map(({ x, y }, i) => {
                            if(i){
                                ctx.lineTo(x, y);
                            }
                        })

                        ctx.strokeStyle = "red";
                        ctx.stroke();
                    } else {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }


                // window.onload = function() {
                    var width  = document.body.offsetWidth;
                    var height = document.body.offsetHeight;
                    canvas.height = height;
                    canvas.width = width;
                    canvas.addEventListener('mousedown', function(e) {
                        this.down = true;
                        this.X = e.pageX ;
                        this.Y = e.pageY ;
                        this.color = rgb();
                        this.line_id = null;// Math.random() + "" + Date.now();


                        // dbo.points.insert({ id: Date.now(), color: this.color, x: this.X, y: this.Y, line_id: this.line_id })
                        // ps.upsert([{ id: Date.now(), color: this.color, x: this.X, y: this.Y, line_id: this.line_id}])
                    }, 0);
                    canvas.addEventListener('mouseup', function() {
                        this.down = false;    
                    }, 0);
                    canvas.addEventListener('mousemove', function(e) {
                        this.style.cursor = 'pointer';
                        if(this.down) {

                            // dbo.points.insert({ id: Date.now(), color: this.color, x: e.pageX, y: e.pageY, line_id: this.line_id })
                            ps.upsert([{ id: Date.now(), color: null, x: e.pageX, y: e.pageY, line_id: this.line_id }])

                            this.X = e.pageX ;
                            this.Y = e.pageY ;
                        }
                    }, 0);

                    function rgb() {
                        color = 'rgb(';
                        for(var i = 0; i< 3; i++) {
                            color += Math.floor(Math.random() * 255)+',';
                        }
                        return color.replace(/\,$/,')');
                    }    
                // };
            }

		</script>
	</body>
</html>
